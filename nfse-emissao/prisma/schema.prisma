generator client {
  provider = "prisma-client-js"
}

model nfePagamento {
  id                      String    @id @default(uuid())
  nfeId                   String
  formaPagamentoCodigo    Int
  formaPagamentoDescricao String
  numeroParcela           Int?
  numeroDocumento         String?
  dataVencimento          DateTime?
  valor                   Float     @default(0)
  operadoraCartaoId       String?
  autorizacao             String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  nfe nfe @relation(fields: [nfeId], references: [id], onDelete: Cascade)
}

model nfe {
  id            String         @id @default(uuid())
  numero        Int
  serie         Int            @default(1)
  cnpjCliente   String
  nomeCliente   String?
  dataEmissao   DateTime
  valorTotal    Float          @default(0)
  status        String         @default("0") // 0: Não transmitida, 1: Autorizada, 2: Cancelada, 3: Em Espera, 4: Rejeitada, 5: Processando
  protocolo     String?
  chaveAcesso   String?        @unique
  danfeImpresso Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  itens         nfeItem[]
  pagamentos    nfePagamento[]

  // Transporte
  modalidadeFrete  Int?    @default(0) // 0 remetente, 1 destinatário, 2 terceiros, 3 transp. próprio remetente, 4 transp. próprio destinatário, 9 sem ocorrência
  transportadoraId String?
  ufVeiculo        String?
  placaVeiculo     String?
  valorFrete       Float?  @default(0)
  volumes          Float?  @default(0)
  tipoVolume       String?
  marcaVolume      String?
  pesoBruto        Float?  @default(0)
  pesoLiquido      Float?  @default(0)

  // Dados da NF-e
  finalidadeEmissao  String?  @default("Normal")
  natureza           String?
  tipoDoc            String? // Saída/Entrada
  desconto           Float?   @default(0)
  tipoOper           String? // Operação Interna/Interestadual/Exterior
  operacao           String? // Presencial/Não Presencial etc
  formaPgto          String?
  percCreditoSimples Float?   @default(0)
  cfopAlternativo    String?
  consumidorFinal    Boolean? @default(false)

  // Adicionais
  numeroPedido             String?
  nomeVendedor             String?
  outrasDespesasAcessorias Float?  @default(0)
  obsAdicionais            String?
  infAdFisco               String?
}

model nfeItem {
  id         String   @id @default(uuid())
  nfeId      String
  produtoId  String?
  descricao  String
  quantidade Float    @default(1)
  valorUnit  Float    @default(0)
  valorTotal Float    @default(0)
  ncm        String?
  cfop       String?
  cst        String?
  ipi        Float?   @default(0)
  pis        Float?   @default(0)
  cofins     Float?   @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  nfe nfe @relation(fields: [nfeId], references: [id], onDelete: Cascade)
}

model operadoraCartao {
  id                String   @id @default(uuid())
  codigo            String   @unique
  bandeiraCodigo    String
  bandeiraDescricao String
  descricao         String
  cnpj              String
  endereco          String?
  uf                String?
  codigoMunicipio   String?
  ativo             Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model configuracao {
  id        String   @id
  chave     String   @unique(map: "Configuracao_chave_key")
  valor     String
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model itemnotafiscal {
  id               String     @id
  notaFiscalId     String
  servicoId        String
  quantidade       Float      @default(1)
  valorUnitario    Float
  valorTotal       Float
  desconto         Float      @default(0)
  tributavel       Boolean    @default(true)
  codigoTributacao String?
  discriminacao    String
  createdAt        DateTime   @default(now())
  updatedAt        DateTime
  notafiscal       notafiscal @relation(fields: [notaFiscalId], references: [id], onDelete: Cascade, map: "ItemNotaFiscal_notaFiscalId_fkey")
  servico          servico    @relation(fields: [servicoId], references: [id], map: "ItemNotaFiscal_servicoId_fkey")

  @@index([notaFiscalId], map: "ItemNotaFiscal_notaFiscalId_idx")
  @@index([servicoId], map: "ItemNotaFiscal_servicoId_idx")
}

model notafiscal {
  id                              String           @id
  numero                          String
  tipo                            String           @default("1")
  status                          String           @default("1")
  naturezaOperacao                Int              @default(1)
  statusNfse                      String?
  codigoVerificacao               String?
  dataEmissao                     DateTime         @default(now())
  competencia                     DateTime         @default(now())
  prestadorId                     String
  tomadorId                       String
  valorServicos                   Float
  valorDeducoes                   Float            @default(0)
  valorPis                        Float            @default(0)
  valorCofins                     Float            @default(0)
  valorInss                       Float            @default(0)
  valorIr                         Float            @default(0)
  valorCsll                       Float            @default(0)
  outrasRetencoes                 Float            @default(0)
  valorLiquidoNfse                Float
  baseCalculo                     Float            @default(0)
  aliquota                        Float            @default(0)
  issRetido                       Boolean          @default(false)
  descontoCondicionado            Float            @default(0)
  descontoIncondicionado          Float            @default(0)
  discriminacao                   String
  exigibilidadeIss                Int              @default(1)
  intermediarioRazaoSocial        String?
  intermediarioCpfCnpj            String?
  intermediarioInscricaoMunicipal String?
  construcaoCivilNumeroMatricula  String?
  construcaoCivilNumeroArt        String?
  codigoCancelamento              String?
  motivoCancelamento              String?
  dataCancelamento                DateTime?
  nfseSubstituidaId               String?          @unique(map: "NotaFiscal_nfseSubstituidaId_key")
  protocolo                       String?
  chaveAcesso                     String?          @db.VarChar(60)
  xmlRPS                          String?          @db.LongText
  xmlRetorno                      String?          @db.LongText
  nfseXML                         String?          @db.LongText
  xmlCancelamento                 String?          @db.LongText
  arquivoNfse                     String?
  dataRecebimento                 DateTime?
  numeroLote                      String?
  createdAt                       DateTime         @default(now())
  updatedAt                       DateTime
  ambiente                        Int              @default(2)
  incentivadorCultural            Boolean          @default(false)
  optanteSimplesNacional          Boolean          @default(true)
  serie                           String           @default("1")
  itemnotafiscal                  itemnotafiscal[]
  notafiscal                      notafiscal?      @relation("notafiscalTonotafiscal", fields: [nfseSubstituidaId], references: [id], map: "NotaFiscal_nfseSubstituidaId_fkey")
  other_notafiscal                notafiscal?      @relation("notafiscalTonotafiscal")
  prestador                       prestador        @relation(fields: [prestadorId], references: [id], map: "NotaFiscal_prestadorId_fkey")
  tomador                         tomador          @relation(fields: [tomadorId], references: [id], map: "NotaFiscal_tomadorId_fkey")

  @@index([prestadorId], map: "NotaFiscal_prestadorId_fkey")
  @@index([tomadorId], map: "NotaFiscal_tomadorId_fkey")
  @@index([chaveAcesso])
}

model prestador {
  id                       String       @id
  cnpj                     String       @unique(map: "Prestador_cnpj_key")
  razaoSocial              String
  nomeFantasia             String?
  inscricaoMunicipal       String
  inscricaoEstadual        String?
  email                    String
  telefone                 String?
  endereco                 String
  numero                   String
  complemento              String?
  bairro                   String
  codigoMunicipio          String
  uf                       String
  cep                      String
  numeroRpsAtual           Int          @default(100)
  regimeEspecialTributacao Int?         @default(0)
  ativo                    Boolean      @default(true)
  exibirConstrucaoCivil    Boolean      @default(false)
  createdAt                DateTime     @default(now())
  updatedAt                DateTime
  ambiente                 Int          @default(2)
  incentivadorCultural     Boolean      @default(false)
  optanteSimplesNacional   Boolean      @default(true)
  serie                    String       @default("1")
  logoPath                 String?
  customer_id_asaas        String?
  integrado_asaas          Boolean      @default(false)
  // Controles de emissão
  emitirNfse               Boolean      @default(true)
  emitirNfe                Boolean      @default(false)
  // Controles de NF-e
  nfeAmbiente              Int          @default(2)
  numeroNfeAtual           Int          @default(1)
  nfeSerie                 String       @default("1")
  // Padrões municipais (migrados de servico)
  codigoTributacao         String?
  itemListaServico         String?
  aliquota                 Float?       @default(0)
  // Parâmetros avançados (DPS / Tributação)
  exigibilidadeIss         Int?         @default(2)
  issRetido                Boolean?     @default(false)
  tpRetIssqn               Int?         @default(1)
  opSimpNac                Int?         @default(1)
  tipoImunidade            Int?         @default(3)
  valorTribFederal         Float?       @default(0)
  valorTribEstadual        Float?       @default(0)
  totalTribMunicipal       Float?       @default(0)
  codigoTribNacional       String?
  logs                     log[]
  notafiscal               notafiscal[]
  usuarios                 usuario[]
}

model servico {
  id                     String           @id
  descricao              String
  valorUnitario          Float
  codigoPais             String?          @default("1058")
  codigoServico          String?
  issRetido              Boolean          @default(false)
  valorDeducoes          Float            @default(0)
  descontoCondicionado   Float            @default(0)
  descontoIncondicionado Float            @default(0)
  valorPis               Float            @default(0)
  valorCofins            Float            @default(0)
  valorInss              Float            @default(0)
  valorIr                Float            @default(0)
  valorCsll              Float            @default(0)
  outrasRetencoes        Float            @default(0)
  ativo                  Boolean          @default(true)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime
  baseCalculo            Float?           @default(0)
  valorIss               Float?           @default(0)
  valorLiquido           Float?           @default(0)
  itemnotafiscal         itemnotafiscal[]
}

model tokenrecuperacaosenha {
  id        String   @id
  token     String   @unique(map: "TokenRecuperacaoSenha_token_key")
  email     String
  expiraEm  DateTime
  utilizado Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model tomador {
  id                 String       @id
  cpfCnpj            String
  tipo               String       @default("J")
  razaoSocial        String
  inscricaoMunicipal String?
  inscricaoEstadual  String?
  email              String
  telefone           String?
  endereco           String
  numero             String
  complemento        String?
  bairro             String
  codigoMunicipio    String
  uf                 String
  cep                String
  ativo              Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime
  notafiscal         notafiscal[]
}

model usuario {
  id          String    @id
  nome        String
  email       String    @unique(map: "Usuario_email_key")
  username    String    @unique
  password    String
  role        String    @default("Usuário")
  ativo       Boolean   @default(true)
  last_access DateTime?
  prestadorId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  logs        log[]
  prestador   prestador @relation(fields: [prestadorId], references: [id], onDelete: Cascade)

  @@index([prestadorId], map: "Usuario_prestadorId_idx")
}

model log {
  id          String    @id
  prestadorId String
  usuarioId   String
  acao        String
  entidade    String
  entidadeId  String
  descricao   String    @db.Text
  dataHora    DateTime  @default(now())
  tela        String
  prestador   prestador @relation(fields: [prestadorId], references: [id], onDelete: Cascade)
  usuario     usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([prestadorId], map: "Log_prestadorId_idx")
  @@index([usuarioId], map: "Log_usuarioId_idx")
  @@index([entidade], map: "Log_entidade_idx")
  @@index([dataHora], map: "Log_dataHora_idx")
}

model listaServicos {
  id         String   @id @default(uuid())
  codigo     String
  codigoItem String?  @map("codigo_item")
  descricao  String
  categoria  String
  codigoNacional String? @map("codigo_nacional")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("lista_servicos")
}

model erros {
  id        String   @id @default(uuid())
  codigo    Int
  mensagem  String
  motivo    String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("erros")
}

model produto {
  id                    String   @id @default(uuid())
  codigo                String   @unique
  codigoBarras          String?
  descricao             String
  ncm                   String?
  cfop                  String?
  unComercial           String?
  unTributaria          String?
  qtdComercial          Float    @default(1)
  qtdTributaria         Float    @default(1)
  precoVenda            Float    @default(0)
  informacoesAdicionais String?
  crt                   String?
  ativo                 Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // ICMS
  icmsCodigo   String? // ex.: 400, 000, 060
  icmsOrigem   String? // 0 nacional, 1 importacao direta, 2 mercado interno
  icmsAliquota Float?  @default(0)

  // IPI
  ipiCst                 String? // 53, 50 etc
  ipiClasseEnquadramento String?
  ipiCodigoEnquadramento String?
  ipiCnpjProdutor        String?
  ipiQtdeSelo            Int?
  ipiAliquota            Float?  @default(0)

  // PIS
  pisCst        String?
  pisAliquota   Float?  @default(0)
  pisStAliquota Float?  @default(0)

  // COFINS
  cofinsCst        String?
  cofinsAliquota   Float?  @default(0)
  cofinsStAliquota Float?  @default(0)

  // OUTROS
  cest                  String?
  escala                String?
  cnpjFabricante        String?
  codigoBeneficioFiscal String?
}

model transportadora {
  id                String   @id @default(uuid())
  codigo            String   @unique
  razaoSocial       String
  endereco          String
  uf                String
  codigoMunicipio   String
  cpfCnpj           String
  inscricaoEstadual String?
  ufVeiculo         String?
  placaVeiculo      String?
  ativo             Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model natureza {
  id        String   @id @default(uuid())
  descricao String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NFSe {
  id                Int      @id @default(autoincrement())
  numeroGuia        Int?
  status            Int      @default(1)
  nfseId            String?  @db.VarChar(100)
  nNfse             String?  @db.VarChar(50)
  codigoVerificacao String?  @db.VarChar(100)
  chaveAcesso       String?  @db.VarChar(200)
  urlNfse           String?  @db.VarChar(400)
  xmlNfse           String?
  nfseBase64Gzip    Bytes?
  rawResponse       String?
  ambiente          Int?
  valorTotal        Float?
  codigoServicoNac  String?  @db.VarChar(20)
  codigoServicoMun  String?  @db.VarChar(20)
  discriminacao     String?
  prestadorCnpj     String?  @db.VarChar(14)
  tomadorCpfCnpj    String?  @db.VarChar(14)
  tomadorEmail      String?  @db.VarChar(200)
  tomadorTelefone   String?  @db.VarChar(20)
  nDps              String?  @db.VarChar(20)
  serie             String?  @db.VarChar(5)
  criadoEm          DateTime @default(now())

  @@index([numeroGuia])
  @@index([chaveAcesso])
}
